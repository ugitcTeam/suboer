<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<title>技术文件更改通知</title>
	<link rel="stylesheet" type="text/css" href="css/style.css" />
	<script src="js/jquery.min.js" type="text/javascript" charset="utf-8" ></script>
	<script type="text/javascript" src="js/app.js" charset="utf-8"></script>
	<style type="text/css" media="screen">
		.inputNumber{width:60px; border:1px;}
		td{overflow:hidden;}
		.orderNo{width: 100px;}
	</style>
</head>
<body>
	<div class="sd-rc">
		<h2 class="title">技术文件更改通知</h2>
		<div>
			<table class="rc-table" style="table-layout: fixed;">
				<tr>
					<td style="width:50px;">EC
					N号</td>
					<td style="width:50px;"><div class="ecnId"></div></td>
					<td style="width:70px;">产品型号</td>
					<td style="width:80px;"><div class="prodNo"></div></td>
					<td style="width:60px;">渠道</td>
					<td style="width:50px;"><div class="saleChan" style="min-width: 50px;"></div></td>
					<td style="width:70px;">变更种类</td>
					<td style="width:50px;"><div class="chgType" style="width: 50px;"></div></td>
					<td style="width:150px;" colspan="2"></td>
					<td style="width:120px;">表单版本：<span class="formVer"></span></td>
					<td style="">编号：SPE R02-014</td>
				</tr>
				<tr>
					<td>序号</td>
					<td>名称</td>
					<td>图号</td>
					<td>SAP编码</td>
					<td colspan="2">更改前</td>
					<td colspan="2">更改后</td>
					<td>更改标记</td>
					<td>更改处数</td>
					<td colspan="2">物控部门意见</td>
				</tr>
				<tr class="lastRow">
					<td>编制</td>
					<td colspan="2"><span class="bz"></span></td>
					<!-- <td></td> -->
					<td>SAP审核</td>
					<td colspan="2"><span class="sapsh"></span></td>
					<td colspan="2">批准</td>
					<td colspan="2"><span class="pz"></span></td>
					<!-- <td></td> -->
					<td colspan="2">物控<span class="wk"></span></td>
				</tr>
			</table>
		</div>
	</div>

</body>
<script type="text/javascript">
	$(function(){
		$(".sd-rc").show();
		var flows=["编制","物控审核"];
		var constant_obj={seNo:"SPE R02-014"};
		var role=0;
		var columns=[
			{field:"rowNo",name:"序号",col:1,fun:"setText"}
			,{field:"names",name:"名称",col:1,fun:"setText"}
			,{field:"phoNo",name:"图号",col:1,fun:"setText"}
			,{field:"sapNo",name:"SAP编码",col:1,fun:"setText"}
			,{field:"preChag",name:"更改前",col:2,flag:"img",img:"bgqmsfj",fun:"preAndImg"}
			,{field:"postChag",name:"更改后",col:2,flag:"img",img:"bghmsfj",fun:"preAndImg"}
			,{field:"chgTag",name:"更改标记",col:1,fun:"roleText"}
			,{field:"chgNo",name:"更改处数",col:1,fun:"roleText"}
			,{field:"dep",name:"物控部门意见",col:2,flag:"html",fun:"bmyj"}
		];

		function setQz(data){
			$(".bz").setSpan(data.bz);
			$(".sapsh").setSpan(data.sapsh);
			$(".pz").setSpan(data.pz);
			$(".wk").setSpan(data.wk);
		}
		function setData(data){
			role=flows.indexOf(data.flow);
			setEco(data);
			addTr(data);
			setQz(data);
			constant_obj=data;
		}
		function getData(){
			var obj=[];
			switch (role) {
				case 0:
					obj=getChg();
					break;
				case 1:
					obj=getDep();
					break;
				default:
					break;
			}
			obj=$.extend(constant_obj,obj);
			eval("var str='"+JSON.stringify(obj)+"';");
			return str;
		}
		//测试数据
		window.dataArr={chgeDescs:[
			{
				rowNo:"1",
				names:"名称",
				phpNo:"图号",
				sapNo:"SAP编码",
				preChag:"更改前",
				postChag:"更改后",
				ggq:"C:/Users/ren90/Desktop/微信截图_20190221161814.png",
				ggh:"C:/Users/ren90/Desktop/微信截图_20190221161814.png",
				supInvAmo:12
			},
			{
				rowNo:"2",
				names:"名称2",
				phpNo:"图号2",
				sapNo:"SAP编码2",
				preChag:"更改前2",
				postChag:"更改后2",
				ggq:"C:/Users/ren90/Desktop/微信截图_20190221161814.png",
				ggh:"C:/Users/ren90/Desktop/微信截图_20190221161814.png",
				supInvAmo:13
			}
		]};
		function setEco(data){
			$(".ecnId").text(data.ecoNo);
			$(".prodNo").text(data.prodNo);
			$(".saleChan").text(data.saleChan);
			$(".chgType").text(data.chgType);
			// $(".chgType").text(data.chgType);
			$(".formVer").text(data.formVer);
		}
		function setText(data,obj){
			var span="<span>"+(data[obj.field]||"")+"</span>";
			return span;
		}
		// 变更前描述和变更后描述赋值
		function preAndImg(data,obj,_i){
			var pre="<pre>"+(data[obj.field]||"")+"</pre>";
			pre+="<img style='width:100px;height:100px;' src="+data[obj.img]+">";
			return pre;
		}
		//流程中输入和显示
		function roleText(data,obj,_i,role){
			var  value=data[obj.field]||"";
			var str="<span>"+value+"</span>";
			if(role==0){
				str="<input type='text' name='"+obj.field+"-"+_i+"'>";
			}
			return str;
		}
		var funs={
			setText:function(data,obj){
				return setText(data,obj);
			},
			preAndImg:function(data,obj,_i){
				return preAndImg(data,obj,_i);
			},
			roleText:function(data,obj,_i){
				return roleText(data,obj,_i,role);
			},
			bmyj:function(data,obj,_i){
				return bmyj(data,obj,_i);
			}
		}
		//创建时需要存放当前数据id，和后面提交时匹配
		function setRow(data,_i){
			var $tr=$("<tr></tr>");
			$tr.attr("id",data.rowNo);
			$tr.data("oldData",data);//把数据放到当前行
			$(columns).each(function(index,value){
				var colspan=this.col;
				var $td=$("<td></td>").attr({"colspan":colspan,field:this.field});
				var $div=$("<div></div>");
				var subHtml=funs[this.fun](data,this,_i);
				$div.append(subHtml);
				$td.append($div);
				$tr.append($td);
			});
			return $tr;
		}
		
		function addTr(data){
			var $lastRow=$(".lastRow");
			$(data.chgeDescs).each(function(i){
				$lastRow.before(setRow(this,i));
			});
			if(role!=1){
				$("input[type='radio']").prop("disabled","disabled");
			}
		}
		var bmyjArr=[
			{type:"text",name:"orderNo",text:"订单号："}
			,{type:"text",name:"other",text:"其他："}
			,{type:"number",name:"invAmo",text:"库存数量："}
			,{type:"number",name:"compInvAmo",text:"公司库存数量："}
			,{type:"number",name:"supInvAmo",text:"供应商库存数量："}
		];

		function createNode(data,flog){
			var str="";
			$(bmyjArr).each(function(index,value){
				var className=this.name;
				var content=flog?createInput(this):createSpan(this.name,data[this.name]);
				str+="<div>"+this.text+content+"</div>";
			});
			return str;
		}
		function createInput(obj){
			var className=obj.name;
			if(obj.type=="number"){
				className+=" inputNumber";
			}
			return "<input class='"+className+"' type='"+obj.type+"' name='"+this.name+"'>";
		}
		function createSpan(className,text){
			return "<span class='"+className+"'>"+(text || "")+"</span>"
		}
		function bmyj(data,obj,_i){
			var div="<div>制品处理意见</div>";
			var $div=$("<div></div>");
			var label=addLabel("立即切换",_i);
			var flag = role == 1;
			var div2=createNode(data,flag);
			return div+label+div2;
		}
		/**
		 * 制品处理意见
		 * @Author   Jackie
		 * @DateTime 2019-03-07
		 * @param    {[type]}   flag    [description]
		 * @param    {[type]}   linenum [description]
		 */
		function addLabel(flag,linenum){
			var $label="";
			var list=["自然消耗","立即切换","按单消耗"];
			$(list).each(function(index,value){
				$label+="<label><input type='radio'";
				$label+=flag==value?"checked":"";
				$label+=" name='billAdv-"+linenum+"' value='"+value+"'>"+value+"</label>";
			});
			return $label;
		}
		var clArr=["orderNo",'other','invAmo','compInvAmo','supInvAmo'];	
		function getDep(){
			// $("td[field='dep']").siblings();
			var list=[];
			var _this=$("td[field='dep']");
			var $radios=$("td[field='dep']").find("[type='radio']");
			$(_this).each(function(){
				list.push(loop(this))
			});
			return list;
		}
		function loop(than){
			var $than=$(than);
			var $tr=$than.closest("tr");
			var data=$tr.data("oldData");
			var billAdv=$than.find("[type='radio']").getRadio1();
			var obj={};
			$(clArr).each(function(){
				obj[this]=$than.find("."+this).val();
			});
			obj.billAdv=billAdv;
			return $.extend(data,obj);
		}
		function getChg(){
			var list=[];
			var rows=$("td[field='chgTag']").closest("tr");
			rows.each(function(){
				list.push(loopChg(this));
			});
			return list;
		}
		function loopChg(trNode){
			var $than=$(trNode);
			var data=$than.data("oldData");
			var chgTag=$than.find("[name^='chgTag']").val();
			var chgNo=$than.find("[name^='chgNo']").val();
			var obj={chgTag:chgTag,chgNo:chgNo};
			return $.extend(data,obj);
		}
		window.getDep=getDep;
		window.addTr=addTr;
		window.setData=setData;
		window.getData=getData;

		window.getDomStr=function () {  
		     var tmpNode = document.createElement('div')
		     tmpNode.appendChild(document.documentElement) 
		     var str = tmpNode.innerHTML
		     tmpNode = null; // 解除引用，以便于垃圾回收  
		     return str;  
		} 
	});
</script>
</html>